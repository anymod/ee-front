<!DOCTYPE html>
<html ng-app="PApp" lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <title><%= product.title %> | eeosk</title>

    <link rel="shortcut icon" href="../img/eeosk_e_128x128.png" type="image/x-icon">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/product/product.css">
  </head>
  <body ng-controller="productCtrl" ng-cloak>

    <div id="wrap">

      <div class="container text-center" ng-show="product && !success" ng-hide="success">

        <div class="navbar navbar-fixed-top navbar-default" role="navigation">
          <div class="container-fluid text-center">
            <img ng-src="../img/eeosk_250x67.png" style="max-width: 150px;" class="pad-3">
          </div>
        </div>

        <div class="max-width-600 pad-15 round-5 white-background">

          <div class="alert alert-danger text-left" ng-if="error">
            There was a problem: {{ error }}
          </div>

          <div class="row margin-0 visible-xs">
            <div style="min-height: 200px;">
              <img ng-src="https://s3.amazonaws.com/eeosk/products/{{ mainImage }}" class="main-image full-width"/>
            </div>
            <div class="row margin-0 text-left">
              <div ng-repeat="image in product.images" ng-click="setMainImage(image)"
                   style="width: 24%; padding-right: 5px; display: inline-block">
                <img ng-src="https://s3.amazonaws.com/eeosk/products/{{ product.images[$index] }}" class="full-width" />
              </div>
            </div>
          </div>

          <div class="hidden-xs">
            <div class="row">
              <div class="col-xs-9">
                <div class="full-width">
                  <img ng-src="https://s3.amazonaws.com/eeosk/products/{{ mainImage }}" class="main-image" />
                </div>
              </div>

              <div class="col-xs-3">
                <img ng-repeat="image in product.images" ng-src="https://s3.amazonaws.com/eeosk/products/{{ image }}"
                     ng-click="setMainImage(image)" class="thumbnail">
              </div>
            </div>
          </div>

          <h4 class="text-left">{{ product.title }}</h4>



          <div class="vert-5 text-left">
            <div class="btn btn-sm btn-default pull-right" ng-click="toggleShowDetails()">
              details
            </div>
            <h2 class="inline-block margin-0">
              {{ link.sellerPrice | currency }}
            </h2>
            <small class="inline-block text-muted">
              <i> + {{ product.shippingPrice | currency }} shipping&nbsp;</i>
            </small>
          </div>

          <p class="text-left" ng-show="showDetails">{{ product.description }}</p>

          <div class="btn btn-lg btn-block btn-success" ng-click="clickPurchase()"><i class="glyphicon glyphicon-shopping-cart"></i> Buy</div>

        </div>
      </div>

      <div class="container" ng-show="product && success" ng-hide="!success">

        <div class="navbar navbar-fixed-top navbar-default text-center" role="navigation">
          <div class="container-fluid text-center">
            <img ng-src="../img/eeosk_250x67.png" style="max-width: 150px;" class="pad-3">
          </div>
        </div>

        <div class="max-width-600 pad-15 round-5 white-background">

          <div class="alert alert-info text-center">
            <h2 class="margin-0">Thank you for your order</h2>
          </div>
          <h3>Order number is <strong>{{ token.orderId }}</strong></h3>
          <p>You will receive an email confirmation shortly at {{ token.email }}</p>
          <a href="javascript:window.print()">Print this page</a>

          <hr>

          <h3>Ships to:</h3>
          <address>
            <strong>{{ address.shipping_name }}</strong><br>
            {{ address.shipping_address_line1 }}<br>
            <span ng-show="order.address.shipping_address_apt">{{ address.shipping_address_apt }}<br></span>
            {{ address.shipping_address_city }}, {{ address.shipping_address_state }} {{ address.shipping_address_zip }}<br>
            {{ address.shipping_address_country }}
          </address>

          <hr>

          <h4>Payment Info</h4>
          {{ token.card.brand }}
          <span class="pull-right">XXXX XXXX XXXX {{ token.card.last4 }}</span>

          <hr>

          <h4>Summary of Charges</h4>

          <table class="table table-bordered">
            <tr>
              <td>{{ product.title }}</td>
              <td class="text-right">{{ link.sellerPrice | currency }}</td>
            </tr>
            <tr>
              <td>Shipping</td>
              <td class="text-right">{{ product.shippingPrice | currency }}</td>
            </tr>
            <tr class="active">
              <td>Order Total</td>
              <td class="text-right">{{ link.sellerPrice + product.shippingPrice | currency }}</td>
            </tr>
          </table>
        </div>

      </div>

      <div id="push"></div>
    </div>

    <br>

    <div id="footer-region">
      <div class="container text-muted text-center">
        <small>
          <a ng-click="modalSource = 'refund_policy'; showModal = true" class="hover-pointer">Refund Policy</a>&nbsp;|
          <a ng-click="modalSource = 'privacy_policy'; showModal = true" class="hover-pointer">Privacy</a>&nbsp;|
          <a ng-click="modalSource = 'terms_of_service'; showModal = true" class="hover-pointer">Terms of Service</a>&nbsp;|
          <a href="mailto:team@eeosk.com" target="_blank">Contact</a>
          <br>
          &copy; eeosk 2014
        </small>
      </div>
    </div>

    <div class="full-screen {{ showModal }}">
      <div class="container max-width-600">
        <button class="btn btn-default btn-block vert-10" ng-click="showModal = false">
          <i class="glyphicon glyphicon-remove"></i> Close
        </button>

        <div ng-if="modalSource" ng-include="modalSource + '.html'"></div>

        <button class="btn btn-default btn-block vert-10" ng-click="showModal = false">
          <i class="glyphicon glyphicon-remove"></i> Close
        </button>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script src="https://cdn.firebase.com/js/client/1.1.2/firebase.js"></script>
    <script>
      var app = angular.module('PApp', [])
      app.constant('FirebaseUrl', "https://fiery-inferno-1584.firebaseIO.com/")
      app.controller('productCtrl', function ($scope, $http, FirebaseUrl) {
        var product = <%- JSON.stringify(product) %>
        var link = <%- JSON.stringify(link) %>
        var charge = Math.round((link.sellerPrice + product.shippingPrice) * 100)
        var env = <%- JSON.stringify(env) %>

        // Setting up scope
        $scope.product = product
        $scope.link = link
        $scope.setMainImage = function (image) {
          $scope.mainImage = image
        }
        $scope.setMainImage(product.images[0])
        $scope.toggleShowDetails = function () {
          $scope.showDetails = !$scope.showDetails
        }

        // Setting up reporting
        var reportOrder = function (link, product, token, address) {
          token.charge = charge
          token.orderId = Math.random().toString().slice(2,11)
          ref = new Firebase(FirebaseUrl)
          ref.child(env).child('orders').child(token.orderId).setWithPriority({
            token: token,
            address: address,
            product: product,
            link: link,
            created: new Date().toUTCString()
          }
          , token.orderId
          , function (err) {
            // Expose only what's needed to scope
            $scope.token = {
              orderId: token.orderId,
              email: token.email,
              card: {
                brand: token.card.brand,
                last4: token.card.last4
              }
            }
            $scope.address = address
            $scope.success = true
            $scope.$apply()
          })
        }
        var reportError = function (link, product, token, address, data) {
          token.charge = charge
          token.errorId = new Date().toUTCString()
          ref = new Firebase(FirebaseUrl)
          ref.child(env).child('error').child(token.errorId).setWithPriority({
            token: token,
            address: address,
            product: product,
            link: link,
            data: data
          }
          , token.errorId
          , function (err) {
            $scope.error = data.message
            $scope.$apply()
          })
        }

        // Setting up Stripe
        var stripeKey = "<%- stripeKey %>"
        var postCharge = function (token, address) {
          $http.post('/stripe/charges/create', {
            stripeToken: token,
            amount: charge,
            product: product,
            link: link,
            address: address
          }).success(function (data, status, headers, config) {
            reportOrder(link, product, token, address)
          }).error(function (data, status, headers, config) {
            reportError(link, product, token, address, data)
          })
        }


        var handler = StripeCheckout.configure({
          key: stripeKey,
          image: '../img/eeosk_e_128x128.png',
          name: 'eeosk',
          // address: true,
          billingAddress: true,
          shippingAddress: true,
          token: function(token, address) { postCharge(token, address) }
        })
        $scope.clickPurchase = function () {
          handler.open({
            name: product.title,
            description: '$' + link.sellerPrice.toFixed(2) + " + $" + product.shippingPrice.toFixed(2) + " shipping",
            amount: charge,
            currency: 'USD'
          })
        }

        // Setting up modals
        $scope.openModal = function (modalName) {
          console.log(modalName)
        }

      })
    </script>

    <!--GA-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-55625421-1', 'auto');
      ga('require', 'displayfeatures');
      ga('require', 'linkid', 'linkid.js');
      ga('send', 'pageview');
    </script>

  </body>
</html>
